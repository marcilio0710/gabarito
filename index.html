<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Corretor de Prova OMR</title>
  <script async src="https://docs.opencv.org/4.8.0/opencv.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video, canvas { width: 90%; max-width: 400px; }
    #nota { font-size: 1.2em; margin: 10px; }
  </style>
</head>
<body>
  <h1>Corretor OMR no Navegador</h1>
  <video id="videoInput" autoplay playsinline></video>
  <canvas id="canvasOutput"></canvas>
  <div id="nota">Aguardando correção...</div>

  <script>
    const ANSWER_KEY = {0:1,1:4,2:0,3:3,4:1}; // configure seu gabarito aqui
    let video = document.getElementById('videoInput');
    let canvas = document.getElementById('canvasOutput');
    let notaDiv = document.getElementById('nota');
    let cap, streaming = false, width = 320, height = 0;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(s => {
          video.srcObject = s;
          video.play();
        })
        .catch(err => notaDiv.innerText = `Erro ao acessar câmera: ${err}`);
      video.addEventListener('canplay', () => {
        if (!streaming) {
          height = video.videoHeight / (video.videoWidth / width);
          video.setAttribute('width', width);
          video.setAttribute('height', height);
          canvas.width = width;
          canvas.height = height;
          cap = new cv.VideoCapture(video);
          streaming = true;
          processVideo();
        }
      }, false);
    }

    function processVideo() {
      if (!streaming) return;
      let src = new cv.Mat(height, width, cv.CV_8UC4);
      let gray = new cv.Mat();
      let out = new cv.Mat.zeros(height, width, cv.CV_8UC3);

      cap.read(src);
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
      cv.Canny(gray, gray, 75, 200);

      // Detecção de bolhas
      let cnts = new cv.MatVector(), hierarchy = new cv.Mat();
      cv.findContours(gray, cnts, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
