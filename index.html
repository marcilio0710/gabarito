<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Corretor de Prova OMR</title>
  <script src="https://docs.opencv.org/4.8.0/opencv.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video, canvas { width: 90%; max-width: 400px; margin: 10px auto; }
    #nota { font-size: 1.2em; margin: 10px; }
  </style>
</head>
<body>
  <h1>Corretor OMR no Navegador</h1>
  <video id="videoInput" autoplay playsinline></video>
  <canvas id="canvasOutput"></canvas>
  <div id="nota">Aguardando inicialização...</div>

  <script>
    const ANSWER_KEY = {0:1,1:4,2:0,3:3,4:1};
    const FPS = 10;
    let video = document.getElementById('videoInput');
    let canvas = document.getElementById('canvasOutput');
    let notaDiv = document.getElementById('nota');
    let cap, src, gray, out;

function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
    .then(stream => {
      video.srcObject = stream;
      video.play();
    })
    .catch(err => {
      notaDiv.innerText = `Erro ao acessar câmera: ${err}`;
    });
}

    function onOpenCvReady() {
      console.log('Executando onOpenCvReady');
      notaDiv.innerText = 'Carregando câmera...';
      startCamera();

      video.addEventListener('canplay', () => {
        if (!cap) {
          video.width = video.videoWidth;
          video.height = video.videoHeight;
          cap = new cv.VideoCapture(video);
          src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
          gray = new cv.Mat();
          out = new cv.Mat.zeros(video.height, video.width, cv.CV_8UC3);
          notaDiv.innerText = 'Captura ativa. Processando...';
          processVideo();
        }
      });
    }

    // Atribui ao evento de carregamento do OpenCV
    cv['onRuntimeInitialized'] = () => {
      console.log('OpenCV pronto');
      onOpenCvReady();
    };
  </script>
</body>
</html>
