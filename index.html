<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Corretor OMR</title>
  <script src="https://docs.opencv.org/4.8.0/opencv.js" onerror="alert('Erro ao carregar OpenCV!')"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video, canvas { width:90%; max-width:400px; margin:10px auto; display: block; }
    #nota { font-size:1.2em; margin:10px; color: red; }
    #status { font-weight: bold; }
  </style>
</head>
<body>
  <h1>Corretor OMR</h1>
  <div id="status">Status: Inicializando...</div>
  <video id="videoInput" autoplay playsinline muted></video>
  <canvas id="canvasOutput"></canvas>
  <div id="nota">Aguardando câmera...</div>

  <script>
    const ANSWER_KEY = {0:1,1:4,2:0,3:3,4:1,5:4,6:3,7:2,8:1,9:0};
    const FPS = 10;
    const video = document.getElementById('videoInput');
    const outC = document.getElementById('canvasOutput');
    const nota = document.getElementById('nota');
    const statusDiv = document.getElementById('status');
    const hidden = document.createElement('canvas');
    const hctx = hidden.getContext('2d');
    let cap, src, gray, out;

    function updateStatus(message) {
      statusDiv.textContent = "Status: " + message;
      console.log(message);
    }

    function showError(message) {
      nota.style.color = 'red';
      nota.textContent = "ERRO: " + message;
      updateStatus(message);
    }

    function startCamera() {
      updateStatus("Solicitando permissão da câmera...");
      
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          video.play().then(() => {
            updateStatus("Câmera iniciada, aguardando OpenCV...");
          }).catch(e => {
            showError("Falha ao reproduzir vídeo: " + e.message);
          });
        })
        .catch(e => {
          showError("Acesso à câmera negado: " + e.message);
        });
    }

    function onOpenCvReady() {
      updateStatus("OpenCV carregado!");
      
      if (!cv || !cv.Mat) {
        showError("OpenCV não está funcionando corretamente");
        return;
      }

      // Verifica se a câmera já está pronta
      if (video.readyState >= 2) {
        setupVideoProcessing();
      } else {
        video.addEventListener('canplay', setupVideoProcessing, { once: true });
        video.addEventListener('error', () => {
          showError("Erro no elemento de vídeo");
        });
        
        // Timeout de segurança
        setTimeout(() => {
          if (!cap) {
            showError("Tempo limite de espera da câmera excedido");
          }
        }, 5000);
      }
    }

    function setupVideoProcessing() {
      updateStatus("Configurando processamento de vídeo...");
      
      try {
        hidden.width = video.videoWidth;
        hidden.height = video.videoHeight;
        outC.width = video.videoWidth;
        outC.height = video.videoHeight;
        
        cap = new cv.VideoCapture(video);
        src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
        gray = new cv.Mat();
        out = new cv.Mat.zeros(video.videoHeight, video.videoWidth, cv.CV_8UC3);
        
        updateStatus("Processando vídeo...");
        nota.textContent = "Aponte para o gabarito";
        nota.style.color = 'black';
        
        processVideo();
      } catch (e) {
        showError("Erro na configuração: " + e.message);
      }
    }

    function processVideo() {
      try {
        hctx.drawImage(video, 0, 0, hidden.width, hidden.height);
        cap.read(src);
        
        if (src.empty()) {
          console.warn('Frame vazio');
          setTimeout(processVideo, 1000/FPS);
          return;
        }

        // Seu código de processamento de imagem continua aqui...
        // ... (mantenha o restante do seu código de processamento)

        setTimeout(processVideo, 1000/FPS);
      } catch (e) {
        showError("Erro no processamento: " + e.message);
      }
    }

    // Verifica se OpenCV já está carregado
    if (window.cv) {
      cv['onRuntimeInitialized'] = onOpenCvReady;
    } else {
      updateStatus("Aguardando carregamento do OpenCV...");
      window.onOpenCvReady = onOpenCvReady;
    }

    // Inicia o processo
    startCamera();
  </script>
</body>
</html>
